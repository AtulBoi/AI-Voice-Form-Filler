import React, { useState, useEffect, useRef, createContext, useContext } from 'react';
import { createRoot } from 'react-dom/client';
import { initializeApp } from 'firebase/app';
import {
  getAuth,
  signInAnonymously,
  onAuthStateChanged,
  signInWithCustomToken,
  signOut
} from 'firebase/auth';
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  collection,
  onSnapshot,
  writeBatch,
  query,
  deleteDoc
} from 'firebase/firestore';
import {
  Scan,
  FileText,
  CheckCircle,
  User,
  Search,
  BookOpen,
  Youtube,
  ExternalLink,
  ChevronRight,
  Shield,
  LogOut,
  Languages,
  Loader2,
  Save,
  UploadCloud,
  AlertCircle,
  MessageCircle,
  Send,
  X,
  Trash2,
  Clock,
  Info,
  Edit3,
  Camera
} from 'lucide-react';

// --- FIREBASE CONFIGURATION ---
const firebaseConfig = JSON.parse(__firebase_config || '{}');
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'janseva-default';

// --- CONFIGURATION (USER EDITS THIS IN CODE) ---
// ⚠️ PASTE YOUR API KEY HERE ⚠️
const GEMINI_API_KEY = ""; 

// --- CONSTANTS & MOCKS ---
const MOCK_PROFILE = {
  fullName: "Ramesh Kumar",
  dob: "2004-05-15",
  gender: "Male",
  category: "OBC",
  income: "85000",
  state: "Uttar Pradesh",
  education: "12th Pass",
  marks10th: "78",
  marks12th: "82",
  disability: "No",
  occupation: "Student"
};

const SAMPLE_SCHEMES = [
  {
    id: "sample_1",
    title: "Post Matric Scholarship for OBC Students",
    provider: "Government",
    benefit: "₹15,000 per year + Fees",
    description: "Financial support for OBC students studying at post-matriculation or post-secondary stage.",
    eligibility_match: "Matches your OBC Category and Income < 2.5L.",
    official_link: "https://scholarships.gov.in",
    required_docs: ["Caste Certificate", "Income Certificate", "Marksheet"],
    status: "new"
  },
  {
    id: "sample_2",
    title: "UP Free Laptop Yojana",
    provider: "State Govt",
    benefit: "Free Laptop",
    description: "For meritorious students of 10th and 12th standard in Uttar Pradesh.",
    eligibility_match: "Matches your State (UP) and 12th Marks > 65%.",
    official_link: "http://upcmo.up.nic.in/",
    required_docs: ["Aadhaar", "Residence Proof", "12th Marksheet"],
    status: "new"
  }
];

const LANGUAGES = [
  { code: 'en', name: 'English' },
  { code: 'hi', name: 'Hindi (हिंदी)' },
  { code: 'hinglish', name: 'Hinglish' }
];

// --- NOTIFICATION CONTEXT ---
const NotificationContext = createContext();

const NotificationProvider = ({ children }) => {
  const [notification, setNotification] = useState(null);

  const showNotification = (message, type = 'info') => {
    setNotification({ message, type });
    setTimeout(() => setNotification(null), 4000);
  };

  return (
    <NotificationContext.Provider value={{ showNotification }}>
      {children}
      {notification && (
        <div className={`fixed top-4 right-4 z-[100] px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 animate-in slide-in-from-top-5 duration-300 ${
          notification.type === 'error' ? 'bg-red-600 text-white' : 
          notification.type === 'success' ? 'bg-green-600 text-white' : 
          'bg-gray-900 text-white'
        }`}>
          {notification.type === 'error' ? <AlertCircle className="w-5 h-5" /> : <Info className="w-5 h-5" />}
          <span className="font-medium text-sm">{notification.message}</span>
        </div>
      )}
    </NotificationContext.Provider>
  );
};

const useNotify = () => useContext(NotificationContext);

// --- COMPONENTS ---

// 1. Landing
const Landing = ({ onEnter, loading }) => (
  <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-orange-50 via-white to-green-50 p-6 text-center">
    <div className="bg-white p-6 rounded-3xl shadow-xl mb-8 animate-bounce-slow border border-orange-100 relative overflow-hidden">
      <div className="absolute inset-0 bg-orange-500/10 rounded-full transform scale-150"></div>
      <Shield className="w-20 h-20 text-orange-600 relative z-10" />
    </div>
    <h1 className="text-5xl md:text-6xl font-extrabold text-gray-900 mb-4 tracking-tight">
      JanSeva <span className="text-orange-600">AI</span>
    </h1>
    <p className="text-gray-600 mb-10 max-w-lg text-xl leading-relaxed">
      The smartest way for Indian citizens to find and apply for Government Schemes.
    </p>
    
    <button
      onClick={onEnter}
      disabled={loading}
      className="group relative w-full max-w-xs bg-gray-900 hover:bg-black text-white font-bold py-4 px-8 rounded-2xl shadow-xl hover:shadow-2xl transition-all transform hover:-translate-y-1 overflow-hidden"
    >
      <div className="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
      <span className="relative flex items-center justify-center gap-3 text-lg">
        {loading ? <Loader2 className="animate-spin" /> : <>Enter App <ChevronRight className="w-5 h-5" /></>}
      </span>
    </button>
    
    <div className="mt-12 flex gap-6 text-sm text-gray-400 font-medium">
      <span className="flex items-center gap-1"><Shield className="w-4 h-4" /> Secure</span>
      <span className="flex items-center gap-1"><User className="w-4 h-4" /> Private</span>
      <span className="flex items-center gap-1"><CheckCircle className="w-4 h-4" /> Verified</span>
    </div>
  </div>
);

// 2. Navigation
const NavBar = ({ user, onViewChange, currentView, onLogout }) => (
  <nav className="bg-white/90 backdrop-blur-md border-b border-gray-200 sticky top-0 z-40 shadow-sm">
    <div className="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
      <div 
        className="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity" 
        onClick={() => onViewChange('dashboard')}
      >
        <div className="bg-orange-600 p-1.5 rounded-lg shadow-sm">
           <Shield className="w-5 h-5 text-white" />
        </div>
        <span className="font-bold text-xl text-gray-900 hidden sm:block">JanSeva AI</span>
      </div>
      
      {user && (
        <div className="flex items-center gap-2">
          <NavButton 
            active={currentView === 'dashboard'} 
            onClick={() => onViewChange('dashboard')} 
            icon={<FileText className="w-5 h-5" />} 
            label="Profile" 
          />
          <NavButton 
            active={currentView === 'schemes'} 
            onClick={() => onViewChange('schemes')} 
            icon={<Search className="w-5 h-5" />} 
            label="Schemes" 
          />
          <div className="w-px h-6 bg-gray-200 mx-2"></div>
          <button 
            onClick={onLogout}
            className="p-2 rounded-xl text-red-500 hover:bg-red-50 transition-colors"
            title="Logout"
          >
            <LogOut className="w-5 h-5" />
          </button>
        </div>
      )}
    </div>
  </nav>
);

const NavButton = ({ active, onClick, icon, label }) => (
  <button 
    onClick={onClick}
    className={`flex items-center gap-2 px-4 py-2 rounded-xl transition-all ${
      active ? 'bg-orange-50 text-orange-700 font-bold shadow-sm ring-1 ring-orange-100' : 'text-gray-500 hover:bg-gray-100 font-medium'
    }`}
  >
    {icon}
    <span className="hidden sm:inline text-sm">{label}</span>
  </button>
);

// 3. Document Uploader
const DocUploader = ({ onExtractionComplete }) => {
  const [uploading, setUploading] = useState(false);
  const [progress, setProgress] = useState(0);
  const fileInputRef = useRef(null);
  const { showNotification } = useNotify();

  const handleFile = async (file) => {
    setUploading(true);
    setProgress(10);

    const timer = setInterval(() => {
      setProgress(p => (p < 90 ? p + 15 : p));
    }, 300);

    try {
      let extractedData = { ...MOCK_PROFILE };

      if (file.type === "text/plain") {
        const text = await file.text();
        const lines = text.split('\n');
        const newData = {};
        lines.forEach(line => {
          const lower = line.toLowerCase();
          if (lower.includes('income')) newData.income = line.match(/\d+/)?.[0] || extractedData.income;
          if (lower.includes('name')) newData.fullName = line.split(':')[1]?.trim() || extractedData.fullName;
          if (lower.includes('caste') || lower.includes('category')) {
             if (lower.includes('obc')) newData.category = 'OBC';
             if (lower.includes('sc')) newData.category = 'SC';
             if (lower.includes('st')) newData.category = 'ST';
          }
        });
        extractedData = { ...extractedData, ...newData };
        showNotification("Parsed data from text file!", "success");
      } else {
        showNotification("AI scanning document...", "info");
      }

      setTimeout(() => {
        clearInterval(timer);
        setProgress(100);
        setTimeout(() => {
          setUploading(false);
          onExtractionComplete(extractedData);
          showNotification("Data extracted successfully!", "success");
        }, 600);
      }, 2000);

    } catch (e) {
      clearInterval(timer);
      setUploading(false);
      showNotification("Failed to read file", "error");
    }
  };

  return (
    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-8">
      <div className="flex items-center gap-3 mb-4">
        <div className="bg-blue-50 p-2.5 rounded-xl text-blue-600">
          <Scan className="w-6 h-6" />
        </div>
        <div>
          <h2 className="text-lg font-bold text-gray-900">Document Upload</h2>
          <p className="text-xs text-gray-500 font-medium">Auto-fill profile from Aadhaar/Certificates</p>
        </div>
      </div>

      {!uploading && progress === 0 ? (
        <div 
          className="border-2 border-dashed border-gray-200 rounded-xl p-8 text-center hover:bg-gray-50 hover:border-blue-300 transition-all cursor-pointer group relative"
          onClick={() => fileInputRef.current?.click()}
        >
          <input 
            type="file" 
            ref={fileInputRef} 
            className="hidden" 
            accept=".pdf,.jpg,.png,.txt" 
            onChange={(e) => e.target.files[0] && handleFile(e.target.files[0])}
          />
          <div className="bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
            <UploadCloud className="w-8 h-8 text-blue-600" />
          </div>
          <p className="text-gray-900 font-bold mb-1">Upload Documents</p>
          <p className="text-xs text-gray-400 mb-6">PDF, JPG, PNG, TXT</p>
          
          <button 
            onClick={(e) => { 
              e.stopPropagation(); 
              handleFile({ type: 'demo' }); 
            }}
            className="relative z-10 text-xs font-bold text-blue-700 bg-blue-50 px-4 py-2 rounded-lg hover:bg-blue-100 transition-colors shadow-sm"
          >
            Try Demo Scan
          </button>
        </div>
      ) : (
        <div className="py-10 text-center">
          <div className="w-full max-w-xs mx-auto bg-gray-100 rounded-full h-2 mb-4 overflow-hidden">
            <div className="bg-blue-600 h-full transition-all duration-300 ease-out" style={{ width: `${progress}%` }} />
          </div>
          <h3 className="text-sm font-bold text-gray-900 animate-pulse">Analyzing Document...</h3>
          <p className="text-xs text-gray-500 mt-1">Extraction engine running</p>
        </div>
      )}
    </div>
  );
};

// 4. Profile Section (Enhanced)
const ProfileSection = ({ profile, setProfile, onSave }) => {
  const [isEditing, setIsEditing] = useState(false);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setProfile(prev => ({ ...prev, [name]: value }));
  };

  const handleSaveClick = () => {
    onSave();
    setIsEditing(false);
  };

  return (
    <div className="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden relative">
      {/* Header Background */}
      <div className="h-32 bg-gradient-to-r from-orange-400 to-orange-600"></div>
      
      {/* Profile Content */}
      <div className="px-6 pb-6">
        {/* Avatar & Actions */}
        <div className="flex justify-between items-end -mt-12 mb-6">
          <div className="bg-white p-1.5 rounded-full shadow-md">
            <div className="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center border-4 border-white text-gray-300">
              <User className="w-12 h-12" />
            </div>
          </div>
          
          <button 
            onClick={() => isEditing ? handleSaveClick() : setIsEditing(true)}
            className={`flex items-center gap-2 px-4 py-2 rounded-xl font-bold text-sm shadow-md transition-all ${
              isEditing 
                ? 'bg-green-600 text-white hover:bg-green-700' 
                : 'bg-gray-900 text-white hover:bg-black'
            }`}
          >
            {isEditing ? <><Save className="w-4 h-4" /> Save Profile</> : <><Edit3 className="w-4 h-4" /> Edit Profile</>}
          </button>
        </div>

        {/* ID Card Details */}
        <div className="mb-6">
          <h2 className="text-2xl font-extrabold text-gray-900">{profile.fullName || "User Name"}</h2>
          <p className="text-gray-500 font-medium flex items-center gap-2">
            {profile.state || "State Not Set"} • {profile.occupation || "Occupation Not Set"}
          </p>
        </div>

        {/* Fields Grid */}
        <div className="bg-gray-50 rounded-xl p-6 border border-gray-100">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-8">
            <ProfileField label="Full Name" name="fullName" value={profile.fullName} editing={isEditing} onChange={handleChange} />
            <ProfileField label="Date of Birth" name="dob" type="date" value={profile.dob} editing={isEditing} onChange={handleChange} />
            <ProfileField label="Annual Income (₹)" name="income" type="number" value={profile.income} editing={isEditing} onChange={handleChange} />
            <ProfileSelect label="Category" name="category" value={profile.category} editing={isEditing} onChange={handleChange} options={["General", "OBC", "SC", "ST", "EWS"]} />
            <ProfileSelect label="Education" name="education" value={profile.education} editing={isEditing} onChange={handleChange} options={["Below 10th", "10th Pass", "12th Pass", "Graduate", "Post Graduate"]} />
            <ProfileField label="State" name="state" value={profile.state} editing={isEditing} onChange={handleChange} />
          </div>
        </div>
      </div>
    </div>
  );
};

const ProfileField = ({ label, editing, value, ...props }) => (
  <div className="flex flex-col">
    <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5">{label}</label>
    {editing ? (
      <input 
        value={value || ''} 
        className="w-full p-2 bg-white border border-gray-300 rounded-lg text-sm font-semibold text-gray-900 focus:ring-2 focus:ring-orange-500 outline-none" 
        {...props} 
      />
    ) : (
      <div className="text-sm font-bold text-gray-800 py-1 border-b border-transparent border-dashed hover:border-gray-300 transition-colors cursor-default truncate">
        {value || <span className="text-gray-400 italic">Not set</span>}
      </div>
    )}
  </div>
);

const ProfileSelect = ({ label, editing, value, options, ...props }) => (
  <div className="flex flex-col">
    <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5">{label}</label>
    {editing ? (
      <select 
        value={value || options[0]} 
        className="w-full p-2 bg-white border border-gray-300 rounded-lg text-sm font-semibold text-gray-900 focus:ring-2 focus:ring-orange-500 outline-none" 
        {...props}
      >
        {options.map(o => <option key={o} value={o}>{o}</option>)}
      </select>
    ) : (
      <div className="text-sm font-bold text-gray-800 py-1 border-b border-transparent border-dashed hover:border-gray-300 transition-colors cursor-default">
        {value || <span className="text-gray-400 italic">Not set</span>}
      </div>
    )}
  </div>
);

// 5. Scheme Finder
const SchemeFinder = ({ user, profile }) => {
  const [loading, setLoading] = useState(false);
  const [schemes, setSchemes] = useState([]);
  const [language, setLanguage] = useState('en');
  const [selectedScheme, setSelectedScheme] = useState(null);
  const [tab, setTab] = useState('all'); 
  const { showNotification } = useNotify();

  useEffect(() => {
    if (!user) return;
    const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'schemes'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const loaded = snapshot.docs.map(d => ({ ...d.data(), firestoreId: d.id }));
      loaded.sort((a, b) => (a.status === 'applied' ? 1 : -1));
      setSchemes(loaded);
    });
    return () => unsubscribe();
  }, [user]);

  const handleFetchSchemes = async () => {
    setLoading(true);
    
    // Fallback if key is missing in code
    if (!GEMINI_API_KEY) {
      setTimeout(() => {
        const batch = writeBatch(db);
        SAMPLE_SCHEMES.forEach(s => {
           const ref = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'schemes'));
           batch.set(ref, { ...s, status: 'new', createdAt: new Date().toISOString() });
        });
        batch.commit();
        setLoading(false);
        showNotification("No API Key set in code. Loaded SAMPLES.", "info");
      }, 1000);
      return;
    }

    try {
      const prompt = `
        Analyze profile: ${JSON.stringify(profile)}.
        Lang: ${language}.
        Task: Return valid JSON array of 4 BEST matching Indian Government Schemes.
        Format: [{"title": "Name", "provider": "Govt", "benefit": "₹Amount/Benefit", "description": "Short Desc", "eligibility_match": "Reason", "official_link": "URL", "required_docs": ["doc1"], "form_fields_needed": ["field1"]}]
      `;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (text) {
        const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
        const parsed = JSON.parse(jsonStr);
        
        const batch = writeBatch(db);
        parsed.forEach(s => {
           const ref = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'schemes'));
           batch.set(ref, { ...s, status: 'new', createdAt: new Date().toISOString() });
        });
        await batch.commit();
        showNotification(`Found ${parsed.length} new schemes!`, "success");
      } else {
        throw new Error("AI returned empty");
      }
    } catch (err) {
      console.error(err);
      showNotification("AI Error. Check API Key in Code.", "error");
    } finally {
      setLoading(false);
    }
  };

  const markApplied = async (scheme) => {
    if(!scheme.firestoreId) return;
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'schemes', scheme.firestoreId), { ...scheme, status: 'applied' });
    showNotification("Marked as Applied", "success");
    setSelectedScheme(null);
  };

  const filtered = schemes.filter(s => tab === 'applied' ? s.status === 'applied' : s.status !== 'applied');

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
      <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row gap-4 justify-between items-center">
        <div className="flex p-1 bg-gray-100 rounded-lg">
          <button onClick={() => setTab('all')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${tab === 'all' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500'}`}>Suggested</button>
          <button onClick={() => setTab('applied')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${tab === 'applied' ? 'bg-white text-green-700 shadow-sm' : 'text-gray-500'}`}>Applied</button>
        </div>

        <div className="flex items-center gap-2 w-full md:w-auto">
          <select value={language} onChange={(e) => setLanguage(e.target.value)} className="bg-gray-50 border border-gray-200 rounded-lg px-2 py-2 text-sm outline-none">
            {LANGUAGES.map(l => <option key={l.code} value={l.code}>{l.name}</option>)}
          </select>
          <button 
            onClick={handleFetchSchemes} 
            disabled={loading}
            className="flex-1 md:flex-none bg-gray-900 text-white px-5 py-2.5 rounded-lg text-sm font-bold hover:bg-black transition-colors flex items-center justify-center gap-2 shadow-md"
          >
            {loading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Search className="w-4 h-4" />}
            {GEMINI_API_KEY ? "Find Schemes (AI)" : "Load Samples"}
          </button>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
        {filtered.map((s, i) => (
          <div key={i} className="bg-white rounded-xl border border-gray-200 overflow-hidden hover:border-orange-300 hover:shadow-md transition-all flex flex-col group">
            <div className="p-5 flex-1">
              <div className="flex justify-between items-start mb-3">
                <span className={`text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded-md ${s.provider === 'Private' ? 'bg-purple-100 text-purple-700' : 'bg-blue-50 text-blue-700'}`}>{s.provider || 'Government'}</span>
                {s.status === 'applied' && <CheckCircle className="w-5 h-5 text-green-500" />}
              </div>
              <h3 className="font-bold text-gray-900 leading-tight mb-2 text-lg">{s.title}</h3>
              <p className="text-sm text-gray-500 line-clamp-2 mb-4">{s.description}</p>
              <div className="bg-orange-50 rounded-lg p-3 border border-orange-100">
                <p className="text-xs font-bold text-orange-800 uppercase mb-1">Benefit</p>
                <p className="text-sm font-bold text-gray-900">{s.benefit}</p>
              </div>
            </div>
            <div className="px-5 py-3 bg-gray-50 border-t border-gray-100 flex gap-3">
              <button onClick={() => setSelectedScheme(s)} className="flex-1 py-2.5 text-sm font-medium text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-100">Details</button>
              {s.status !== 'applied' && (
                <button onClick={() => setSelectedScheme({ ...s, mode: 'fill' })} className="flex-1 py-2.5 text-sm font-bold text-white bg-orange-600 rounded-lg hover:bg-orange-700 shadow-sm">Fill It</button>
              )}
            </div>
          </div>
        ))}
        {filtered.length === 0 && !loading && (
           <div className="col-span-full flex flex-col items-center justify-center py-20 text-gray-300">
             <BookOpen className="w-16 h-16 mb-4 opacity-20" />
             <p className="font-medium">No schemes found yet.</p>
             <p className="text-sm">Click "Find Schemes" to start.</p>
           </div>
        )}
      </div>

      {/* Detail/Fill Modal */}
      {selectedScheme && (
        <div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm">
          <div className="bg-white w-full sm:max-w-lg sm:rounded-2xl rounded-t-2xl max-h-[90vh] overflow-y-auto animate-in slide-in-from-bottom-10 shadow-2xl">
            <div className="p-4 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
              <h3 className="font-bold truncate flex-1 text-lg">{selectedScheme.title}</h3>
              <button onClick={() => setSelectedScheme(null)} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-5 h-5" /></button>
            </div>
            
            <div className="p-6 space-y-6">
              {selectedScheme.mode === 'fill' ? (
                <>
                  <div className="bg-green-50 p-4 rounded-xl border border-green-100">
                    <h4 className="font-bold text-green-800 flex items-center gap-2 mb-2"><CheckCircle className="w-5 h-5" /> Data Prepared</h4>
                    <p className="text-sm text-green-700">We've organized your profile data. Click below to visit the official portal and paste details.</p>
                  </div>
                  <div className="bg-slate-900 text-slate-300 p-4 rounded-xl font-mono text-xs overflow-x-auto">
                    {Object.entries(profile).map(([k,v]) => v && <div key={k}><span className="text-purple-400">{k}:</span> <span className="text-yellow-300">"{v}"</span></div>)}
                  </div>
                  <div className="space-y-3 pt-2">
                    <a href={selectedScheme.official_link} target="_blank" rel="noreferrer" className="flex items-center justify-center w-full py-3.5 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-xl transition-all shadow-lg shadow-orange-200">
                      Open Official Website <ExternalLink className="w-4 h-4 ml-2" />
                    </a>
                    <button onClick={() => markApplied(selectedScheme)} className="w-full py-3.5 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-xl">Mark as Applied</button>
                  </div>
                </>
              ) : (
                <>
                  <Section title="Why you are eligible">
                    <p className="text-sm text-gray-700 bg-blue-50 p-3 rounded-lg border border-blue-100">{selectedScheme.eligibility_match}</p>
                  </Section>
                  <Section title="Required Documents">
                     <ul className="list-disc pl-5 text-sm text-gray-600 space-y-1">{selectedScheme.required_docs?.map(d => <li key={d}>{d}</li>)}</ul>
                  </Section>
                  <Section title="Video Guide">
                    <a href={`https://www.youtube.com/results?search_query=${encodeURIComponent(selectedScheme.title + " how to apply")}`} target="_blank" className="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-red-50 hover:border-red-200 group transition-all cursor-pointer">
                      <span className="text-sm font-medium text-gray-700 group-hover:text-red-600">Watch Tutorial</span>
                      <Youtube className="w-5 h-5 text-gray-400 group-hover:text-red-600" />
                    </a>
                  </Section>
                </>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

const Section = ({ title, children }) => (
  <div className="space-y-2">
    <h4 className="font-bold text-gray-900 text-sm uppercase tracking-wide">{title}</h4>
    {children}
  </div>
);

// 6. Chat Assistant
const ChatAssistant = ({ profile }) => {
  const [open, setOpen] = useState(false);
  const [msgs, setMsgs] = useState([{ role: 'ai', text: "Namaste! How can I help you today?" }]);
  const [input, setInput] = useState("");
  const [thinking, setThinking] = useState(false);
  const bottomRef = useRef(null);

  useEffect(() => bottomRef.current?.scrollIntoView({ behavior: "smooth" }), [msgs, open]);

  const send = async () => {
    if(!input.trim()) return;
    if(!GEMINI_API_KEY) {
      setMsgs(p => [...p, { role: 'user', text: input }, { role: 'ai', text: "Please set GEMINI_API_KEY in the code to chat." }]);
      setInput("");
      return;
    }
    const userText = input;
    setInput("");
    setMsgs(p => [...p, { role: 'user', text: userText }]);
    setThinking(true);

    try {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ contents: [{ parts: [{ text: `System: You are JanSahayak. User Profile: ${JSON.stringify(profile)}. User: ${userText}` }] }] })
      });
      const d = await res.json();
      setMsgs(p => [...p, { role: 'ai', text: d.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't understand." }]);
    } catch(e) {
      setMsgs(p => [...p, { role: 'ai', text: "Connection error." }]);
    } finally {
      setThinking(false);
    }
  };

  return (
    <>
      {!open && <button onClick={() => setOpen(true)} className="fixed bottom-6 right-6 bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-full shadow-xl z-40 transition-transform hover:scale-105"><MessageCircle className="w-6 h-6" /></button>}
      {open && (
        <div className="fixed bottom-6 right-6 w-80 sm:w-96 h-[500px] bg-white rounded-2xl shadow-2xl border border-gray-200 z-50 flex flex-col overflow-hidden animate-in slide-in-from-bottom-10">
          <div className="bg-orange-600 p-4 flex justify-between items-center text-white">
            <div className="flex items-center gap-2"><MessageCircle className="w-5 h-5" /><span className="font-bold">JanSahayak</span></div>
            <button onClick={() => setOpen(false)} className="hover:bg-white/20 rounded p-1"><X className="w-5 h-5" /></button>
          </div>
          <div className="flex-1 p-4 overflow-y-auto bg-gray-50 space-y-3">
            {msgs.map((m, i) => (
              <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[85%] p-3 text-sm rounded-2xl ${m.role === 'user' ? 'bg-gray-800 text-white rounded-br-none' : 'bg-white text-gray-800 border border-gray-200 rounded-bl-none shadow-sm'}`}>{m.text}</div>
              </div>
            ))}
            {thinking && <Loader2 className="w-4 h-4 animate-spin text-gray-400 ml-2" />}
            <div ref={bottomRef} />
          </div>
          <div className="p-3 bg-white border-t border-gray-100 flex gap-2">
            <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} placeholder="Ask question..." className="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-orange-500" />
            <button onClick={send} className="bg-orange-600 text-white p-2 rounded-lg hover:bg-orange-700"><Send className="w-4 h-4" /></button>
          </div>
        </div>
      )}
    </>
  );
};

// --- MAIN APP ---
const Main = () => {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('landing');
  const [profile, setProfile] = useState({});
  const [loading, setLoading] = useState(true);
  const { showNotification } = useNotify();

  // Init Auth - But DO NOT auto-enter. Just set user state.
  useEffect(() => {
    const init = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    init();

    return onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
      // Logic to load profile data if user exists
      if(u) {
        getDoc(doc(db, 'artifacts', appId, 'users', u.uid, 'profile', 'main'))
          .then(s => s.exists() && setProfile(s.data()));
      }
    });
  }, []);

  // Explicit Entry Handler
  const handleEnterApp = () => {
    if(user) {
      setView('dashboard');
    } else {
      showNotification("Initializing secure session...", "info");
    }
  };

  const handleSaveProfile = async () => {
    if(!user) return;
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main'), profile);
    showNotification("Profile saved successfully", "success");
  };

  if(loading) return <div className="h-screen flex items-center justify-center bg-gray-50"><Loader2 className="w-10 h-10 animate-spin text-orange-600" /></div>;

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-900">
      {view === 'landing' ? (
        <Landing onEnter={handleEnterApp} loading={loading} />
      ) : (
        <>
          <NavBar user={user} onViewChange={setView} currentView={view} onLogout={() => { signOut(auth); setView('landing'); }} />
          
          <main className="max-w-5xl mx-auto px-4 py-8 pb-24">
            {view === 'dashboard' && (
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                {/* Left Column: Profile Identity */}
                <div className="lg:col-span-2 space-y-8">
                  <ProfileSection profile={profile} setProfile={setProfile} onSave={handleSaveProfile} />
                  <DocUploader onExtractionComplete={(d) => setProfile(p => ({...p, ...d}))} />
                </div>

                {/* Right Column: Quick Actions & Status */}
                <div className="space-y-6">
                  <div className="bg-gradient-to-br from-orange-600 to-orange-700 text-white rounded-2xl p-6 shadow-xl relative overflow-hidden group cursor-pointer transition-transform hover:-translate-y-1" onClick={() => { handleSaveProfile(); setView('schemes'); }}>
                    <div className="relative z-10">
                      <h3 className="text-xl font-bold mb-2">Find Benefits</h3>
                      <p className="text-orange-100 text-sm mb-6 leading-relaxed">
                        {Object.keys(profile).length > 3 ? "Profile ready! Click to search schemes." : "Complete your profile to find schemes."}
                      </p>
                      <div className="bg-white/20 backdrop-blur-sm text-white px-4 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 group-hover:bg-white group-hover:text-orange-700 transition-all">
                        Search Schemes <ChevronRight className="w-4 h-4" />
                      </div>
                    </div>
                    <Shield className="absolute -right-6 -bottom-6 w-32 h-32 opacity-10 group-hover:opacity-20 transition-opacity" />
                  </div>
                  
                  <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                     <h4 className="font-bold text-gray-800 mb-4 text-sm uppercase tracking-wide flex items-center gap-2"><Clock className="w-4 h-4" /> Profile Health</h4>
                     <div className="space-y-4">
                        <div>
                          <div className="flex justify-between text-xs mb-1 font-medium text-gray-500">
                            <span>Completion</span>
                            <span>{Math.min(100, Object.keys(profile).filter(k => profile[k]).length * 10)}%</span>
                          </div>
                          <div className="w-full bg-gray-100 rounded-full h-2">
                            <div className="bg-green-500 h-2 rounded-full" style={{width: `${Math.min(100, Object.keys(profile).filter(k => profile[k]).length * 10)}%`}}></div>
                          </div>
                        </div>
                        <div className="flex items-center gap-3 p-3 bg-blue-50 rounded-lg text-xs text-blue-700 font-medium">
                          <Info className="w-4 h-4 shrink-0" />
                          Upload Income Certificate to unlock more schemes.
                        </div>
                     </div>
                  </div>
                </div>
              </div>
            )}

            {view === 'schemes' && (
              <div className="max-w-5xl mx-auto">
                <div className="mb-8">
                  <h2 className="text-3xl font-bold text-gray-900 mb-2">Scheme Matcher</h2>
                  <p className="text-gray-500">AI-powered recommendations based on your profile.</p>
                </div>
                <SchemeFinder user={user} profile={profile} />
              </div>
            )}
          </main>

          <ChatAssistant profile={profile} />
        </>
      )}
    </div>
  );
};

export default function JanSevaApp() {
  return (
    <NotificationProvider>
      <Main />
    </NotificationProvider>
  );
}
